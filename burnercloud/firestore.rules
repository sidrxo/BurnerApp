rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== HELPER FUNCTIONS =====

    function isAuthenticated() {
      return request.auth != null;
    }

    function isSiteAdmin() {
      return isAuthenticated() &&
             request.auth.token.get('role', '') == 'siteAdmin' &&
             request.auth.token.get('active', false) == true;
    }

    function isVenueAdmin() {
      return isAuthenticated() &&
             request.auth.token.get('role', '') in ['venueAdmin', 'subAdmin'] &&
             request.auth.token.get('active', false) == true;
    }

    function isScannerForVenue(venueId) {
      return isAuthenticated() &&
             request.auth.token.get('role', '') == 'scanner' &&
             request.auth.token.get('active', false) == true &&
             request.auth.token.get('venueId', '') == venueId;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserVenueId() {
      return request.auth.token.get('venueId', '');
    }

    function canAccessVenueData(venueId) {
      return isSiteAdmin() ||
             (isVenueAdmin() && getUserVenueId() == venueId);
    }

    function isValidTicketStatus(status) {
      return status in ['pending', 'confirmed', 'cancelled', 'used'];
    }

    // ===== ADMINS =====

    match /admins/{adminId} {
      allow read: if isSiteAdmin() || isOwner(adminId);
      allow write: if isSiteAdmin();
    }

    // ===== SCANNERS =====

    match /scanners/{scannerId} {
      allow read: if isSiteAdmin() || isOwner(scannerId);
      allow write: if isSiteAdmin();
    }

    // ===== USERS =====

    match /users/{userId} {
      allow read: if isSiteAdmin() || isOwner(userId) || isVenueAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) &&
                    // Prevent role/permission escalation
                    request.resource.data.role == resource.data.role &&
                    request.resource.data.venuePermissions == resource.data.venuePermissions;
      allow delete: if false; // Never delete users

      // Bookmarks
      match /bookmarks/{eventId} {
        allow read, write: if isOwner(userId);
        allow read: if isSiteAdmin();
      }
    }

    // ===== VENUES =====

    match /venues/{venueId} {
      allow read: if true; // Public venue directory
      allow create: if isSiteAdmin();
      allow update: if isSiteAdmin() ||
                    (isVenueAdmin() && getUserVenueId() == venueId);
      allow delete: if isSiteAdmin();
    }

    // ===== TAGS =====

    match /tags/{tagId} {
      // Everyone can read tags (for mobile app display)
      allow read: if true;
      // Only site admins can write (managed via cloud functions)
      allow write: if isSiteAdmin();
    }

    // ===== EVENTS =====

    match /events/{eventId} {
      allow read: if true; // Public event listings
      allow create: if isSiteAdmin() ||
                    (isVenueAdmin() &&
                     request.resource.data.venueId == getUserVenueId());

      allow update: if isSiteAdmin() ||
                    (isVenueAdmin() &&
                     resource.data.venueId == getUserVenueId() &&
                     // Prevent manipulation of critical fields
                     request.resource.data.venueId == resource.data.venueId &&
                     request.resource.data.createdAt == resource.data.createdAt);

      allow delete: if isSiteAdmin();

      // ===== TICKETS SUBCOLLECTION =====
      // THIS IS THE MISSING PIECE!
      match /tickets/{ticketId} {
        // Read tickets in this event
        allow read: if isSiteAdmin() ||
                    (isAuthenticated() && resource.data.userId == request.auth.uid) ||
                    (isVenueAdmin() &&
                     get(/databases/$(database)/documents/events/$(eventId)).data.venueId == getUserVenueId());

        // Only server can create tickets (via Cloud Functions)
        allow create: if false;

        // Users can soft-delete their own tickets
        allow update: if isOwner(resource.data.userId) &&
                      (
                        // Soft delete
                        (request.resource.data.deleted == true &&
                         request.resource.data.deletedAt is timestamp) ||
                        // Or no changes (for reads that trigger updates)
                        request.resource.data == resource.data
                      );

        // Scanners can mark tickets as used
        allow update: if isScannerForVenue(
                        get(/databases/$(database)/documents/events/$(eventId)).data.venueId
                      ) &&
                      request.resource.data.status == 'used' &&
                      request.resource.data.usedAt is timestamp &&
                      request.resource.data.scannedBy == request.auth.uid;

        // Venue admins can update tickets for their venue
        allow update: if isVenueAdmin() &&
                      get(/databases/$(database)/documents/events/$(eventId)).data.venueId == getUserVenueId() &&
                      isValidTicketStatus(request.resource.data.status);

        // Site admins can do anything
        allow write: if isSiteAdmin();

        // No hard deletes
        allow delete: if false;
      }
    }

    // ===== TOP-LEVEL TICKETS (if any exist) =====

    match /tickets/{ticketId} {
      // Read own tickets
      allow read: if isSiteAdmin() ||
                  (isAuthenticated() && resource.data.userId == request.auth.uid) ||
                  (isVenueAdmin() && resource.data.venueId == getUserVenueId());

      // Only server can create tickets (via Cloud Functions)
      allow create: if false;

      // Users can soft-delete their own tickets
      allow update: if isOwner(resource.data.userId) &&
                    (
                      // Soft delete
                      (request.resource.data.deleted == true &&
                       request.resource.data.deletedAt is timestamp) ||
                      // Or no changes (for reads that trigger updates)
                      request.resource.data == resource.data
                    );

      // Scanners can mark tickets as used
      allow update: if isScannerForVenue(resource.data.venueId) &&
                    request.resource.data.status == 'used' &&
                    request.resource.data.usedAt is timestamp &&
                    request.resource.data.scannedBy == request.auth.uid;

      // Venue admins can update tickets for their venue
      allow update: if isVenueAdmin() &&
                    resource.data.venueId == getUserVenueId() &&
                    isValidTicketStatus(request.resource.data.status);

      // Site admins can do anything
      allow write: if isSiteAdmin();

      // No hard deletes
      allow delete: if false;
    }

    // ===== TRANSACTIONS =====

    match /transactions/{transactionId} {
      allow read: if isSiteAdmin() ||
                  (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow write: if false; // Server-side only
    }

    // ===== PENDING PAYMENTS =====

    match /pendingPayments/{paymentIntentId} {
      allow read: if isSiteAdmin() ||
                  (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow write: if false; // Server-side only
    }

    // ===== FAILED PURCHASES =====

    match /failedPurchases/{purchaseId} {
      allow read: if isSiteAdmin();
      allow write: if false;
    }

    // ===== AUDIT LOGS =====

    match /auditLogs/{logId} {
      allow read: if isSiteAdmin();
      allow write: if false;
    }

    // ===== METRICS & STATS =====

    match /metrics/{dateId} {
      allow read: if isSiteAdmin() || isVenueAdmin();
      allow write: if false;
    }

    match /eventStats/{eventId} {
      allow read: if isSiteAdmin() || isVenueAdmin();
      allow write: if false;
    }
  }
}
